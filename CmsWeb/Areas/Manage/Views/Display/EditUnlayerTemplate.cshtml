@using System.Configuration
@using CmsData
@using CmsData.Codes
@using CmsWeb.Areas.Main.Models
@using CmsWeb.Models
@model Content
@{
    ViewBag.Title = "Edit Template";
    ViewBag.PageHeader = "Edit Template";
    Layout = ViewExtensions2.TouchPointLayout();
    int tid = ViewBag.TemplateID;
    var c = ViewExtensions2.GetContent(tid);
    CMSDataContext CurrentDatabase = ViewBag.CurrentDatabase;
    var roleList = ContentModel.fetchRoles(CurrentDatabase);
}
@* @using (Html.BeginForm("ContentUpdate", "Display", FormMethod.Post)) *@

<div class="row">
    <div class="col-md-10 col-lg-8">
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-10">
                            <iframe src="/Email/EmailBody/@emptytemplate.Id?useUnlayer=true" height="600" frameborder="0" style="width: 100%; height: 600px;" id="email-body" name="email-body"></iframe>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="draft-modal">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Save Draft</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newName" class="control-label">Draft Name</label>
                    <input type="text" id="newName" name="newName" class="form-control" />
                </div>
            </div>
            <div class="modal-footer">
                <input type="button" value="Cancel" class="btn btn-default" data-dismiss="modal" />
                <input id="SaveDraftButton" type="button" value="Submit" class="btn btn-primary" />
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="editor-modal" style="overflow-y: hidden !important;" data-backdrop="static" data-keyboard="false">
    <div class="scrolleditor">
        <div class="modal-dialog modal-lg" style="height: 100vh; overflow-y: auto;">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="pull-right" style="margin-bottom: 5px;">
                                <a id="create-special-link" class="btn btn-default btn-sm"><i class="fa fa-link"></i> Insert Special Link</a>
                                <a href="https://docs.touchpointsoftware.com/EmailTexting/EmailReplacements.html" target="_blank" class="btn btn-default btn-sm"><i class="fa fa-question-circle"></i> Email Replacement Codes</a>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">
                            <form>
                                <textarea id="htmleditor" name="htmleditor" class="form-control" rows="15"></textarea>
                            </form>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <input type="button" value="Cancel" class="btn btn-default" id="cancel-edit" />
                        <input type="submit" value="Save" class="btn btn-primary" id="save-edit" />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="unlayer-editor-modal" style="overflow-y: hidden !important;" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="pull-right" style="margin-bottom: 5px;">
                            <a id="create-special-link" class="btn btn-default btn-sm"><i class="fa fa-link"></i> Insert Special Link</a>
                            <a href="https://docs.touchpointsoftware.com/EmailTexting/EmailReplacements.html" target="_blank" class="btn btn-default btn-sm"><i class="fa fa-question-circle"></i> Email Replacement Codes</a>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12">
                        <div id="unlayerEditor" style="height: 500px;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <input type="button" value="Cancel" class="btn btn-default" id="unlayer-cancel-edit" />
                <input type="submit" value="Save" class="btn btn-primary" id="unlayer-save-edit" />
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="special-links-modal">
    <div class="modal-dialog" style="margin-top: 60px;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Add Special Link</h4>
            </div>
            <div class="modal-body">
                <form id="special_links_form">
                    <div class="row form-group">
                        <div class="col-sm-4">
                            <label for="special_links_type">Type</label>
                        </div>
                        <div class="col-sm-8">
                            <select class="form-control" id="special_links_type" name="special_links_type">
                                <option value="0" selected>&lt;not set&gt;</option>
                                <option value="registerlink">Register Link (Individual)</option>
                                <option value="registerlink2">Register Link 2 (Family)</option>
                                <option value="regretslink">Regrets Link</option>
                                <option value="rsvplink">RSVP Link</option>
                                <option value="sendlink">Send Link (Individual)</option>
                                <option value="sendlink2">Send Link 2 (Family)</option>
                                <option value="supportlink">Support Link</option>
                                <option value="votelink">Vote Link</option>
                            </select>
                        </div>
                    </div>
                    <div id="org_id" class="row form-group">
                        <div class="col-sm-4">
                            <label for="org_id">Org ID</label>
                        </div>
                        <div class="col-sm-8">
                            <input type="number" class="form-control" name="org_id" />
                        </div>
                    </div>
                    <div id="meeting_id" class="row form-group">
                        <div class="col-sm-4">
                            <label for="meeting_id">Meeting ID</label>
                        </div>
                        <div class="col-sm-8">
                            <input type="number" class="form-control" name="meeting_id" />
                        </div>
                    </div>
                    <div id="message" class="row form-group">
                        <div class="col-sm-4">
                            <label for="message">Message</label>
                        </div>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" name="message" />
                        </div>
                    </div>
                    <div id="small_group" class="row form-group">
                        <div class="col-sm-4">
                            <label for="small_group">Small Group</label>
                        </div>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" name="small_group" />
                        </div>
                    </div>
                    <div id="confirmation" class="row form-group">
                        <div class="col-sm-4">
                            <label for="confirmation">Confirmation</label>
                        </div>
                        <div class="col-sm-8">
                            <select class="form-control" name="confirmation">
                                <option value="true" selected>Yes, send confirmation</option>
                                <option value="false">No, do not send confirmation</option>
                            </select>
                        </div>
                    </div>
                </form>
                <div id="result" class="row form-group">
                    <div class="col-sm-12">
                        <label for="tag">Copy and paste this into the link URL field:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" name="tag" style="cursor:text;" readonly />
                            <span class="input-group-btn">
                                <button class="btn btn-primary done-special-links-modal" type="button">Copy and Close</button>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="button" value="Cancel" class="btn btn-default close-special-links-modal" />
                </div>
            </div>
        </div>
    </div>
</div>
@section scripts
{
    @Fingerprint.Script("/Content/touchpoint/lib/select2/js/select2.min.js")
    @ViewExtensions2.CkEditor()
    @ViewExtensions2.UnlayerEditor()
    @Fingerprint.Script("/Content/touchpoint/js/email/compose.js")
    <script type="text/javascript">
    $(function() {
      var extraSmallDevice = $('.device-xs').is(':visible');
      var smallDevice = $('.device-sm').is(':visible');
      if (extraSmallDevice || smallDevice) {
        $('#Schedule').val($('#ScheduleIso').val());
        $('#Schedule').attr('type', 'datetime-local');
      } else {
        $("div.scheduleDateTime")
          .datetimepicker({ format: 'MM/DD/YYYY h:mm A', widgetPositioning: { horizontal: 'left' } });
      }

      $("#Recover").click(function() {
          var t = $(this);
          swal({
              title: "Are you sure?",
              text: t.data("confirm"),
              showCancelButton: true,
              closeOnConfirm: true
            },
            function() {
              window.location = "/Email/{0}?templateID={1}&recover=true"
                .format($("#id").val(), $("#TemplateID").val());
            });
        });


      $("#AddCC")
        .click(function() {
          if ($(this).is(':checked')) {
            $("#ccdiv").show(1000);
          } else {
            $("#ccdiv").hide(1000);
            $("#Cc").val('');
          }
        });

      $("#ChangeSched")
        .click(function() {
          if ($(this).is(':checked')) {
            $("#scheddiv").show(1000);
          } else {
            $("#scheddiv").hide(1000);
            $("#Schedule").val('');
            $("#ScheduleIso").val('');
          }
        });

    });

    function AddSelected(ret) {
      var peopleWithoutEmail = [], duplicates = [];
      var recipients = {};
      $("#Recipients option")
        .each(function(i, option) {
          var m = option.value.match(/\(([0-9]+)\)/);
          if (m) {
            recipients[parseInt(m[1])] = 1;
          }
        });

      // ret will be an array
      for (var i = 0; i < ret.length; i++) {
        // Check for people without emails
        if (ret[i].email === null || ret[i].email.length === 0) {
          peopleWithoutEmail.push(ret[i].name);
          continue;
        }
        // Check for duplicates among additional recipients
        if ($("#additional-recipient-li-" + ret[i].pid).length) {
          continue;
        }
        // Check for duplicates among original recipients
        if (recipients[ret[i].pid]) {
          duplicates.push(ret[i].name);
          continue;
        }

        $("#additional-recipients")
          .append(
            '<li id="additional-recipient-li-' +
            ret[i].pid +
            '">' +
            ret[i].name +
            '  <input type="hidden" name="AdditionalRecipients" value="' +
            ret[i].pid +
            '"/>' +
            '  <a href="javascript:RemoveRecipient(' +
            ret[i].pid +
            ');"><i class="fa fa-times-circle red"></i></a>' +
            '</li>'
          );
      }

      $('#additional-recipients-alerts').empty();
      if (peopleWithoutEmail.length > 0) {
        if (peopleWithoutEmail.length > 1) {
          $('#additional-recipients-alerts')
            .append('<p>The following people have no active email addresses and were not added to this email:</p>');
        } else {
          $('#additional-recipients-alerts')
            .append('<p>The following person has no active email address and was not added to this email:</p>');
        }
        var ul = $('<ul></ul>');
        $.each(peopleWithoutEmail,
          function(i, name) {
            ul.append('<li>' + name + '</li>');
          });
        $('#additional-recipients-alerts').append(ul);
      }

      if (duplicates.length > 0) {
        $('#additional-recipients-alerts')
          .append('<p>The following ' +
            ((duplicates.length > 1) ? 'selected people were' : 'person was') +
            ' already going to receive the email:</p>');
        var ul = $('<ul></ul>');
        $.each(duplicates,
          function(i, name) {
            ul.append('<li>' + name + '</li>');
          });
        $('#additional-recipients-alerts').append(ul);
      }

      if ($('#additional-recipients-alerts').is(':empty')) {
        $('#additional-recipients-alerts').hide();
      } else {
        $('#additional-recipients-alerts').show();
      }

      UpdatePersonCount();
    }

    function RemoveRecipient(pid) {
      $('#additional-recipient-li-' + pid).remove();
      UpdatePersonCount();
    }

    function UpdatePersonCount() {
      if ($("#person-count").length > 0) {
        var newCount = $('#Recipients option').length + $('#additional-recipients li').length;
        $('#person-count')
          .text(newCount + (newCount > 1 ? ' people' : ' person') + '@(Model.wantParents ? " including parents." : ".")');
      }
    }
    </script>
}
